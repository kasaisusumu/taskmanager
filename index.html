<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>高度なタスク管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    .draggable {
      cursor: grab;
    }
    /* 完了タスクのスタイル */
    .task-done {
      opacity: 0.5;
      text-decoration: line-through;
    }
    /* モーダル表示用 */
    #editTaskModal {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">高度なタスク管理</h1>

    <!-- ナビゲーション -->
    <div class="flex gap-4 mb-6">
      <a href="#" onclick="showSection('task')" class="text-blue-600 underline">タスク一覧</a>
      <a href="#" onclick="showSection('calendar')" class="text-blue-600 underline">カレンダー</a>
      <a href="#" onclick="showSection('timeline')" class="text-blue-600 underline">タイムライン</a>
    </div>

    <!-- タスク管理セクション -->
    <div id="taskSection">
      <div class="flex gap-2 mb-4">
        <input id="projectName" type="text" placeholder="新しいプロジェクト名" class="p-2 border rounded flex-1" />
        <input id="projectColor" type="color" value="#3b82f6" title="プロジェクト色を選択" class="w-12 h-12 p-0 border rounded" />
        <button onclick="addProject()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">追加</button>
      </div>
      <div id="projectArea" class="space-y-8 mb-8"></div>
    </div>

    <!-- カレンダーセクション -->
    <div id="calendarSection" style="display: none">
      <div class="bg-white p-4 rounded shadow">
        <div class="mb-2">
          <select id="calendarView" onchange="changeCalendarView()" class="border p-1 rounded">
            <option value="dayGridMonth">月</option>
            <option value="timeGridWeek">週</option>
            <option value="timeGridDay">日</option>
          </select>
        </div>
        <div id="calendar"></div>
      </div>
    </div>

    <!-- タイムラインセクション -->
    <div id="timelineSection" style="display: none">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-xl font-semibold mb-4">タイムライン（期限順）</h2>
        <ul id="timelineList" class="space-y-2"></ul>
      </div>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div id="editTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded p-6 w-96 max-w-full shadow-lg">
      <h2 class="text-xl mb-4">タスク編集</h2>
      <form id="editTaskForm" onsubmit="submitEditTask(event)">
        <input type="hidden" id="editTaskId" />
        <div class="mb-3">
          <label for="editTaskName" class="block mb-1 font-semibold">タスク名</label>
          <input type="text" id="editTaskName" class="w-full border rounded px-2 py-1" required />
        </div>
        <div class="mb-3">
          <label for="editTaskDeadline" class="block mb-1 font-semibold">期限 (YYYY-MM-DD)</label>
          <input type="date" id="editTaskDeadline" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-3">
          <label for="editTaskPoint" class="block mb-1 font-semibold">ポイント (1～5)</label>
          <input type="number" id="editTaskPoint" class="w-full border rounded px-2 py-1" min="1" max="5" required />
        </div>
        <div class="mb-3">
          <label for="editTaskComment" class="block mb-1 font-semibold">コメント</label>
          <textarea id="editTaskComment" class="w-full border rounded px-2 py-1" rows="3"></textarea>
        </div>
        <div class="mb-3 flex items-center gap-2">
          <input type="checkbox" id="editTaskRepeat" />
          <label for="editTaskRepeat" class="select-none">繰り返しタスクにする</label>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="px-3 py-1 border rounded">キャンセル</button>
          <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">保存</button>
        </div>
      </form>
    </div>
  </div>

<script>
  let projectIdCounter = 0;
  let calendar;
  let allTasks = [];
  let allProjects = [];

  const STORAGE_KEY = "advancedTaskManagerData";

  document.addEventListener("DOMContentLoaded", () => {
    calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "dayGridMonth",
      height: 600,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      events: []
    });
    calendar.render();

    loadData();

    showSection('task');

    // タイムラインのSortable初期化
    initSortable();
  });

  function showSection(section) {
  document.getElementById("taskSection").style.display = section === 'task' ? 'block' : 'none';
  document.getElementById("calendarSection").style.display = section === 'calendar' ? 'block' : 'none';
  document.getElementById("timelineSection").style.display = section === 'timeline' ? 'block' : 'none';
  if (section === 'timeline') renderTimeline();  // ここで呼ぶ
}


  function changeCalendarView() {
    const view = document.getElementById("calendarView").value;
    calendar.changeView(view);
  }

  // プロジェクト追加
  function addProject() {
    const name = document.getElementById("projectName").value.trim();
    const color = document.getElementById("projectColor").value;

    if (!name) return alert("プロジェクト名を入力してください。");

    const id = `project-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    const newProject = { id, name, color };
    allProjects.push(newProject);

    renderProjects();
    saveData();

    document.getElementById("projectName").value = "";
    document.getElementById("projectColor").value = "#3b82f6";
  }

  // プロジェクト編集（名前と色）
  function editProject(projectId) {
    const project = allProjects.find(p => p.id === projectId);
    if (!project) return;

    const newName = prompt("プロジェクト名を編集してください。", project.name);
    if (!newName || !newName.trim()) return;

    const newColor = prompt("プロジェクト色を16進カラーコードで入力してください（例: #3b82f6）", project.color);
    if (!newColor || !/^#[0-9a-fA-F]{6}$/.test(newColor)) {
      alert("正しい16進カラーコードを入力してください。");
      return;
    }

    project.name = newName.trim();
    project.color = newColor;

    renderProjects();
    renderCalendarEvents();
    renderTimeline();
    saveData();
  }

  // プロジェクト削除
  function deleteProject(projectId) {
    if (!confirm("本当にこのプロジェクトを削除しますか？ プロジェクトに属するタスクもすべて削除されます。")) return;
    allProjects = allProjects.filter(p => p.id !== projectId);
    allTasks = allTasks.filter(t => t.projectId !== projectId);

    renderProjects();
    renderCalendarEvents();
    renderTimeline();
    saveData();
  }

  // プロジェクト表示
  function renderProjects() {
    const container = document.getElementById("projectArea");
    container.innerHTML = "";

    if(allProjects.length === 0){
      container.innerHTML = `<p class="text-gray-500">まだプロジェクトがありません。上のフォームで追加してください。</p>`;
      return;
    }

    allProjects.forEach(proj => {
      const projectDiv = document.createElement("div");
      projectDiv.className = "bg-white p-4 rounded shadow";

      projectDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold flex items-center gap-2">
            <span class="w-4 h-4 rounded" style="background-color:${proj.color}; display:inline-block;"></span>
            ${proj.name}
          </h2>
          <div class="flex gap-2">
            <button onclick="editProject('${proj.id}')" class="px-2 py-1 bg-yellow-300 rounded hover:bg-yellow-400">編集</button>
            <button onclick="deleteProject('${proj.id}')" class="px-2 py-1 bg-red-400 text-white rounded hover:bg-red-500">削除</button>
          </div>
        </div>
        <button onclick="showAddTaskForm('${proj.id}', this)" class="mb-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">タスク追加</button>
        <div id="taskList-${proj.id}" class="space-y-1"></div>
      `;

      container.appendChild(projectDiv);

      renderTasks(proj.id);
    });
  }

  // タスク表示
  function renderTasks(projectId) {
  const container = document.getElementById(`taskList-${projectId}`);
  container.innerHTML = "";

  const tasks = allTasks.filter(t => t.projectId === projectId);

  // ✅ 未完了タスク → 完了タスクの順に並べる
  const sortedTasks = [...tasks.filter(t => !t.done), ...tasks.filter(t => t.done)];

  sortedTasks.forEach(task => {
  const div = document.createElement("div");
  div.className = `flex items-center justify-between p-2 border-b hover:bg-gray-100`;

  // チェックボックス + タスク名 + 期限
  const leftDiv = document.createElement("div");
  leftDiv.className = "flex items-center space-x-2";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = task.done;
  checkbox.onchange = (e) => toggleDone(task.id, e.target.checked);

  const spanName = document.createElement("span");
  spanName.textContent = task.name;
  spanName.style.cursor = "default";
  if (task.done) {
    spanName.style.textDecoration = "line-through";
    spanName.style.color = "#888";
  }

  leftDiv.appendChild(checkbox);
  leftDiv.appendChild(spanName);

  // 期限があれば表示（例：YYYY-MM-DD形式）
  if (task.deadline) {
    const spanDeadline = document.createElement("span");
    spanDeadline.textContent = `: ${task.deadline}`;
    spanDeadline.className = "ml-4 text-sm text-glay-600 font-semibold";  // 期限を目立たせたいなら色やサイズ調整
    leftDiv.appendChild(spanDeadline);
  }

    // 右側に編集アイコンと削除アイコン
    const rightDiv = document.createElement("div");
    rightDiv.className = "flex items-center space-x-2";

    const editIcon = document.createElement("button");
    editIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 hover:text-blue-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z" />
    </svg>`;
    editIcon.title = "編集";
    editIcon.onclick = () => openEditModal(task.id);

    const deleteIcon = document.createElement("button");
    deleteIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600 hover:text-red-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>`;
    deleteIcon.title = "削除";
    deleteIcon.onclick = () => deleteTask(task.id);

    rightDiv.appendChild(editIcon);
    rightDiv.appendChild(deleteIcon);

    div.appendChild(leftDiv);
    div.appendChild(rightDiv);

    container.appendChild(div);
  });
}

  // タスク追加フォームを表示・非表示切替
  function showAddTaskForm(projectId, btn) {
    // 既にフォームがあれば消す
    const existingForm = document.getElementById(`addTaskForm-${projectId}`);
    if (existingForm) {
      existingForm.remove();
      return;
    }
    // 作成
    const formDiv = document.createElement("div");
    formDiv.id = `addTaskForm-${projectId}`;
    formDiv.className = "mb-4 bg-gray-50 p-3 rounded";

    formDiv.innerHTML = `
      <form onsubmit="addTask(event, '${projectId}')">
        <div class="flex gap-2 flex-wrap">
          <input type="text" name="taskName" placeholder="タスク名" required class="p-1 border rounded flex-grow" />
                   <input type="date" name="taskDeadline" class="p-1 border rounded" />
          <select name="taskPoint" class="p-1 border rounded" required>
            <option value="1">ポイント1（低）</option>
            <option value="2">ポイント2</option>
            <option value="3" selected>ポイント3</option>
            <option value="4">ポイント4</option>
            <option value="5">ポイント5（高）</option>
          </select>
          <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">追加</button>
        </div>
      </form>
    `;

    btn.insertAdjacentElement('afterend', formDiv);
  }

  // タスク追加処理
  function addTask(event, projectId) {
    event.preventDefault();
    const form = event.target;
    const name = form.taskName.value.trim();
    const deadline = form.taskDeadline.value || null;
    const point = Number(form.taskPoint.value);

    if (!name) {
      alert("タスク名は必須です。");
      return;
    }

    const id = `task-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    const newTask = {
      id,
      projectId,
      name,
      deadline,
      point,
      done: false,
      comment: "",
      repeat: false,
    };

    allTasks.push(newTask);

    renderTasks(projectId);
    renderCalendarEvents();
    renderTimeline();
    saveData();

    form.reset();
    // 追加フォームを閉じる
    const formDiv = document.getElementById(`addTaskForm-${projectId}`);
    if (formDiv) formDiv.remove();
  }

  // タスク完了切り替え
  function toggleDone(taskId, done) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    task.done = done;
    renderTasks(task.projectId);
    renderCalendarEvents();
    renderTimeline();
    saveData();
  }

  // タスク削除（確認付き）
  function deleteTask(taskId) {
    if (!confirm("このタスクを本当に削除しますか？")) return;
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;

    allTasks = allTasks.filter(t => t.id !== taskId);
    renderTasks(task.projectId);
    renderCalendarEvents();
    renderTimeline();
    saveData();
  }

  // 編集モーダル表示
  function openEditModal(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;

    document.getElementById("editTaskId").value = task.id;
    document.getElementById("editTaskName").value = task.name;
    document.getElementById("editTaskDeadline").value = task.deadline || "";
    document.getElementById("editTaskPoint").value = task.point;
    document.getElementById("editTaskComment").value = task.comment || "";
    document.getElementById("editTaskRepeat").checked = task.repeat || false;

    document.getElementById("editTaskModal").style.display = "flex";
  }

  // 編集モーダル閉じる
  function closeEditModal() {
    document.getElementById("editTaskModal").style.display = "none";
  }

  // 編集モーダル送信
  function submitEditTask(event) {
    event.preventDefault();
    const id = document.getElementById("editTaskId").value;
    const task = allTasks.find(t => t.id === id);
    if (!task) return;

    const name = document.getElementById("editTaskName").value.trim();
    if (!name) {
      alert("タスク名は必須です。");
      return;
    }

    task.name = name;
    task.deadline = document.getElementById("editTaskDeadline").value || null;
    task.point = Number(document.getElementById("editTaskPoint").value);
    task.comment = document.getElementById("editTaskComment").value.trim();
    task.repeat = document.getElementById("editTaskRepeat").checked;

    renderTasks(task.projectId);
    renderCalendarEvents();
    renderTimeline();
    saveData();
    closeEditModal();
  }

  // カレンダーイベント生成＆表示
  function renderCalendarEvents() {
    const events = allTasks.map(task => {
      if (!task.deadline) return null;
      const proj = allProjects.find(p => p.id === task.projectId);
      return {
        id: task.id,
        title: task.name,
        start: task.deadline,
        backgroundColor: proj ? proj.color : "#999",
        borderColor: proj ? proj.color : "#999",
        textColor: task.done ? "#999" : "#fff",
      };
    }).filter(e => e !== null);

    calendar.removeAllEvents();
    calendar.addEventSource(events);
  }

  // タイムライン表示（期限順）
  function renderTimeline() {
  const container = document.getElementById("timelineList");
  container.innerHTML = "";

  // 完了タスクと未完了タスクを分ける
  const incompleteTasks = allTasks.filter(t => !t.done);
  const completeTasks = allTasks.filter(t => t.done);

  // 日付順でソート
  const sortByDate = (a, b) => {
    const d1 = a.deadline ? new Date(a.deadline) : new Date(8640000000000000); // 無限大
    const d2 = b.deadline ? new Date(b.deadline) : new Date(8640000000000000);
    return d1 - d2;
  };

  const sorted = [...incompleteTasks.sort(sortByDate), ...completeTasks.sort(sortByDate)];

  sorted.forEach(task => {
    const project = allProjects.find(p => p.id === task.projectId);
    const li = document.createElement("li");
    li.className = `p-3 rounded shadow flex justify-between items-center ${task.done ? "task-done" : ""}`;
    li.style.backgroundColor = project ? project.color : "#ccc";

    li.innerHTML = `
      <div>
        <div class="font-bold">${task.name}</div>
        <div class="text-sm">${task.deadline ? `期限: ${task.deadline}` : "期限なし"} / ポイント: ${task.point}</div>
      </div>
      <div class="flex gap-2 items-center">
        <input type="checkbox" ${task.done ? "checked" : ""} onchange="toggleTaskDone('${task.id}')" />
        <button onclick="editTask('${task.id}')" class="text-blue-500 underline text-sm">編集</button>
      </div>
    `;
    container.appendChild(li);
  });
}




  // Sortableの初期化（タイムライン用）
  function initSortable() {
    const timelineList = document.getElementById("timelineList");
    Sortable.create(timelineList, {
      animation: 150,
      ghostClass: 'bg-gray-300',
      onEnd: function(evt) {
        // TODO: 並び替え後の処理（必要なら保存など）
      }
    });
  }

  // データ保存
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ projects: allProjects, tasks: allTasks }));
  }

  // データ読み込み
  function loadData() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return;

    try {
      const obj = JSON.parse(data);
      allProjects = obj.projects || [];
      allTasks = obj.tasks || [];
      renderProjects();
      renderCalendarEvents();
      renderTimeline();
    } catch {
      console.warn("データの読み込みに失敗しました。");
    }
  }
  function toggleTaskDone(taskId) {
  const task = allTasks.find(t => t.id === taskId);
  if (!task) return;
  task.done = !task.done;

  saveData();

  // リロードするまで並び順は変えず、見た目だけ変える
  const checkbox = document.querySelector(`input.task-checkbox[onclick="toggleTaskDone('${taskId}')"]`);
  const li = checkbox.closest("li");
  li.classList.toggle("task-done", task.done);
}

document.addEventListener("DOMContentLoaded", () => {
  // ...
  loadData();
  renderTimeline(); // ←ここで完了済みを下に分けて描画
});

</script>
</body>
</html>
